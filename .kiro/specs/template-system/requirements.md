# 要件定義書

## はじめに

SumiClockは現在、プログラムで時刻テキストを描画する単純な実装になっています。この機能拡張では、Figmaなどのデザインツールで作成したテンプレートを使用して、より柔軟で美しい時計画像を生成できるようにします。

## 用語集

- **テンプレート**: Figmaなどで作成された、時計のデザインベースとなる画像ファイル（SVGまたはPNG）
- **動的要素**: 時刻、日付など、実行時に変化する情報
- **レイアウト設定**: テンプレート内での動的要素の配置情報（座標、フォント、サイズなど）
- **テンプレートエンジン**: テンプレートと動的要素を合成して最終画像を生成するシステム
- **E-paperディスプレイ**: Kindle、Koboなどの電子ペーパーディスプレイ

## 要件

### 要件1: テンプレートファイルの管理

**ユーザーストーリー:** 開発者として、複数のデザインテンプレートを管理できるようにしたい。そうすることで、用途やデバイスに応じて異なるデザインを提供できる。

#### 受入基準

1. システムは、`templates/`ディレクトリ内のテンプレートファイルを読み込むこと
2. システムは、SVG形式とPNG形式の両方のテンプレートをサポートすること
3. システムは、設定ファイルで使用するテンプレートを指定できること
4. システムは、テンプレートファイルが存在しない場合、明確なエラーメッセージを表示すること
5. システムは、複数のテンプレートを同時に管理できること

### 要件2: レイアウト設定の定義

**ユーザーストーリー:** 開発者として、テンプレート内での動的要素の配置を柔軟に設定したい。そうすることで、デザインに合わせて要素の位置やスタイルを調整できる。

#### 受入基準

1. システムは、YAML形式でレイアウト設定を定義できること
2. レイアウト設定には、各動的要素の座標（x, y）を指定できること
3. レイアウト設定には、フォント、フォントサイズ、色を指定できること
4. レイアウト設定には、テキストの配置（左寄せ、中央、右寄せ）を指定できること
5. システムは、レイアウト設定ファイルが不正な場合、検証エラーを表示すること

### 要件3: 動的要素の合成

**ユーザーストーリー:** ユーザーとして、テンプレート上に現在時刻や日付が正確に表示されることを期待する。そうすることで、常に最新の情報を確認できる。

#### 受入基準

1. システムは、テンプレート画像に時刻テキストを合成すること
2. システムは、テンプレート画像に日付テキストを合成すること（オプション）
3. システムは、指定されたタイムゾーンに基づいて時刻を表示すること
4. システムは、レイアウト設定に従って、テキストを正確な位置に配置すること
5. システムは、E-paper最適化のため、高コントラストな白黒画像を生成すること

### 要件4: SVGテンプレートの処理

**ユーザーストーリー:** 開発者として、SVGテンプレートを使用したい。そうすることで、ベクター形式の利点（拡大縮小、編集の容易さ）を活用できる。

#### 受入基準

1. システムは、SVGファイルを読み込むこと
2. システムは、SVG内のプレースホルダー（例: `{{TIME}}`, `{{DATE}}`）を実際の値に置換すること
3. システムは、SVGをPNG形式に変換すること
4. システムは、変換時に指定された解像度を維持すること
5. システムは、SVG処理に失敗した場合、PNGテンプレートへのフォールバックを提供すること

### 要件5: PNGテンプレートの処理

**ユーザーストーリー:** 開発者として、PNGテンプレートを使用したい。そうすることで、複雑なSVG処理なしにシンプルな実装ができる。

#### 受入基準

1. システムは、PNG画像ファイルを背景として読み込むこと
2. システムは、PNG背景の上にテキストレイヤーを合成すること
3. システムは、既存のPillow実装と互換性を保つこと
4. システムは、グレースケールモード（'L'）で画像を処理すること
5. システムは、最終的にPNG形式で画像を出力すること

### 要件6: 設定の柔軟性

**ユーザーストーリー:** 管理者として、環境変数や設定ファイルでテンプレートシステムを制御したい。そうすることで、デプロイ環境ごとに異なる設定を適用できる。

#### 受入基準

1. システムは、`config.yaml`でテンプレート設定を定義できること
2. システムは、環境変数でテンプレート設定を上書きできること
3. システムは、テンプレートが指定されていない場合、既存の実装（プログラム描画）にフォールバックすること
4. システムは、無効な設定値に対して明確なエラーメッセージを表示すること
5. システムは、設定変更時にキャッシュを無効化すること

### 要件7: パフォーマンスとキャッシング

**ユーザーストーリー:** ユーザーとして、画像生成が高速であることを期待する。そうすることで、E-paperデバイスでの表示更新がスムーズになる。

#### 受入基準

1. システムは、テンプレートファイルを初回読み込み時にメモリにキャッシュすること
2. システムは、生成された画像をRedisにキャッシュすること（既存機能）
3. システムは、テンプレート処理のパフォーマンスが既存実装と同等以上であること
4. システムは、SVG変換処理を最適化すること
5. システムは、不要なファイルI/Oを最小限に抑えること

### 要件8: 後方互換性

**ユーザーストーリー:** 既存ユーザーとして、アップデート後も既存の設定で動作することを期待する。そうすることで、移行がスムーズになる。

#### 受入基準

1. システムは、テンプレートが設定されていない場合、既存の描画方式を使用すること
2. システムは、既存のAPI（`/clock.png`）を変更しないこと
3. システムは、既存の設定ファイル形式と互換性を保つこと
4. システムは、既存のDocker環境で動作すること
5. システムは、既存のテストが引き続き成功すること

### 要件9: エラーハンドリング

**ユーザーストーリー:** 開発者として、問題が発生した際に明確なエラー情報を得たい。そうすることで、迅速にデバッグできる。

#### 受入基準

1. システムは、テンプレートファイルが見つからない場合、ファイルパスを含むエラーを記録すること
2. システムは、レイアウト設定が不正な場合、具体的な問題箇所を示すこと
3. システムは、SVG処理に失敗した場合、詳細なエラー情報をログに記録すること
4. システムは、フォントファイルが見つからない場合、デフォルトフォントにフォールバックすること
5. システムは、すべてのエラーケースで適切なHTTPステータスコードを返すこと

### 要件10: ドキュメントとサンプル

**ユーザーストーリー:** 新規開発者として、テンプレートシステムの使い方を理解したい。そうすることで、独自のテンプレートを作成できる。

#### 受入基準

1. システムは、サンプルテンプレート（SVGとPNG）を提供すること
2. システムは、サンプルレイアウト設定ファイルを提供すること
3. システムは、テンプレート作成ガイドをREADMEに含めること
4. システムは、Figmaからのエクスポート手順を文書化すること
5. システムは、トラブルシューティングガイドを提供すること
